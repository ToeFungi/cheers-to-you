<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-toast">
  <template>
    <style include="shared-styles iron-flex">
      :host {
        display: block;

        padding: 10px;
      }

      .toast {
        margin-bottom: 0.2em;
      }

      .pronunciation {
        margin-top: 0;
        font-style: italic;
      }

      .version {
        text-align: center;
      }
    </style>

    <div class="card">
      <h1>[[selectedToast.language]]</h1>
      <p class="toast">[[selectedToast.toast]]</p>
      <p class="pronunciation">- [[selectedToast.pronunciation]] <paper-icon-button on-tap="_playTTS" icon="av:volume-up"></paper-icon-button></p>
      <p class="translation">"[[selectedToast.translation]]"</p>
      <p class="note">[[selectedToast.note]]</p>

      <!--<div class="layout horizontal">-->
        <!--<div class="flex">-->
          <!--<paper-button raised hidden$="[[_hidePreviousBtn(previousToast, selectedToast)]]" on-click="_previousToast">No! Back one!</paper-button>-->
        <!--</div>-->
        <!--<div class="flex"></div>-->
        <!--<div class="flex">-->
          <!--<paper-button raised on-click="_populateWindow">Let's have another</paper-button>-->
        <!--</div>-->
      <!--</div>-->

      <div class="layout horizontal">
        <div hidden$="[[_hidePreviousBtn(previousToast, selectedToast)]]" on-click="_previousToast">
          <paper-icon-button icon="arrow-back"></paper-icon-button>
          Previous
        </div>
        <div class="flex"></div>
        <div on-click="_populateWindow">
          Another
          <paper-icon-button icon="arrow-forward"></paper-icon-button>
        </div>
      </div>
    </div>

    <p class="version">Version: [[version]]</p>
  </template>

  <script>
      class MyToast extends Polymer.Element {
          static get is() { return 'my-toast'; }

          static get properties() {
              return {
                  active: {
                      type: Boolean,
                      observer: '_getToasts'
                  },
                  toasts: Array,
                  selectedToast: Object,
                  previousToast: Object,
                  version: String
              }
          }

          _getToasts(active) {
              if (!active) return;

              new Promise((resolve, reject) => {
                  let xhr = new XMLHttpRequest;
                  xhr.onload = () => resolve(new Response(xhr.responseText, {status: xhr.status}));
                  xhr.onerror = () => reject(new TypeError('Local request failed'));
                  xhr.open('GET', 'res/language_toasts.json');
                  xhr.send(null);
              })
                  .then((resp) => resp.json())
                  .then((data) => this.toasts = data)
                  .then(() => this._populateWindow())
                  .catch(() => alert('Something went wrong.'));
          }

          _hidePreviousBtn(previousToast, selectedToast) {
              return previousToast === selectedToast || this.previousToast === undefined;
          }

          _playTTS() {
              if (!window.TTS)
                  return this._messageDispatch({message: 'Your device doesn\'t like our speaker', duration: 5000});

              window.TTS
                  .speak({
                      text: this.selectedToast.toast,
                      locale: this.selectedToast.locale,
                      rate: 1
                  }, () => {
                      console.log('Sound played successfully');
                  }, (reason) => {
                      console.log(reason);
                      this._messageDispatch({message: 'Apologies, the speaker seems to be drunk!', duration: 5000});
                  });
          }

          _messageDispatch(evt) {
              this.dispatchEvent(new CustomEvent('toast', {bubbles: true, composed: true, detail: {
                      message: evt.message,
                      duration: evt.duration
                  }}));
          }

          _previousToast() {
              this.selectedToast = this.previousToast;
          }

          _populateWindow() {
              this.previousToast = this.selectedToast;
              this.selectedToast = this._getRandomToast();
          }

          _getRandomToast() {
              let newToast = this.toasts[Math.floor(Math.random() * Math.floor(this.toasts.length))];

              while (newToast === this.selectedToast)
                  newToast = this.toasts[Math.floor(Math.random() * Math.floor(this.toasts.length))];

              return newToast;
          }
      }

      window.customElements.define(MyToast.is, MyToast);
  </script>
</dom-module>